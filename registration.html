<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Register for the 2025 SUTTC Table Tennis Tournament at Strathmore University. Pay via card or Lipa na M-Pesa.">
  <meta name="keywords" content="SUTTC, Table Tennis, Tournament, Strathmore University, Registration">
  <meta name="author" content="Sidney Nduti">
  <link rel="stylesheet" href="css/registration.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <title>Register for SUTTC 2025 Tournament</title>
</head>
<body>
<div class="registration-page">
  <div class="navigation">
    <div class="logo">
      <img src="img/logo.jpeg" alt="SUTTC Logo" style="width: 100%; height: 100%; object-fit: contain;" loading="lazy">
    </div>
    <div class="hamburger-menu">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <div class="nav-buttons">
      <a href="index.html"><button class="nav-button">Home</button></a>
      <a href="registration.html"><button class="nav-button">Register</button></a>
      <a href="about.html"><button class="nav-button">About</button></a>
      <a href="contact.html"><button class="nav-button">Contact</button></a>
    </div>
  </div>

  <div class="registration-section">
    <h2 class="section-title">Register for SUTTC 2025 Tournament</h2>
    <form id="registration-form" class="registration-form" onsubmit="return handlePayment(event)">
      <!-- User Details -->
      <div class="form-group">
        <label for="full-name">Full Name</label>
        <input type="text" id="full-name" name="full-name" placeholder="Enter your full name" required>
      </div>
      <div class="form-group">
        <label for="phone">Phone Number</label>
        <input type="tel" id="phone" name="phone" placeholder="e.g., 0712345678" required>
      </div>
      <!-- Gender Selection -->
      <div class="form-group">
        <label>Gender</label>
        <div class="gender-options">
          <label>
            <input type="radio" name="gender" value="male" required> Male
          </label>
          <label>
            <input type="radio" name="gender" value="female" required> Female
          </label>
        </div>
      </div>
      <!-- Tournament Categories (Checkboxes) -->
      <div class="form-group">
        <label>Tournament Categories</label>
        <div class="category-options">
          <label>
            <input type="checkbox" name="category" value="under-18" onchange="updateForm()"> Under 18 (Boys & Girls) - 300 Kshs
          </label>
          <label>
            <input type="checkbox" name="category" value="singles" onchange="updateForm()"> Singles (Men & Ladies) - 400 Kshs
          </label>
          <label>
            <input type="checkbox" name="category" value="mixed-team" onchange="updateForm()"> Mixed Team (2 Men & 2 Ladies) - 1800 Kshs
          </label>
          <label>
            <input type="checkbox" name="category" value="family-team" onchange="updateForm()"> Family Team (Amateur Division) - 1000 Kshs
          </label>
        </div>
      </div>
      <!-- Mixed Team Details -->
      <div id="mixed-team-details" class="team-details hidden">
        <div class="form-group">
          <label for="mixed-team-name">Mixed Team Name</label>
          <input type="text" id="mixed-team-name" name="mixed-team-name" placeholder="Enter your team name">
        </div>
        <div class="form-group">
          <label>Team Members (2 Men, 2 Ladies)</label>
          <input type="text" name="mixed-team-member" placeholder="Member 1 Name" class="team-member">
          <input type="text" name="mixed-team-member" placeholder="Member 2 Name" class="team-member">
          <input type="text" name="mixed-team-member" placeholder="Member 3 Name" class="team-member">
          <input type="text" name="mixed-team-member" placeholder="Member 4 Name" class="team-member">
        </div>
      </div>
      <!-- Family Team Details -->
      <div id="family-team-details" class="team-details hidden">
        <div class="form-group">
          <label for="family-team-name">Family Team Name</label>
          <input type="text" id="family-team-name" name="family-team-name" placeholder="Enter your team name">
        </div>
      </div>
      <div class="form-group">
        <label>Registration Fee</label>
        <p id="fee-display" class="fee-display">Select categories to see the total fee</p>
      </div>

      <!-- Payment Method Selection -->
      <div class="form-group">
        <label>Payment Method</label>
        <div class="payment-options">
          <label>
            <input type="radio" name="payment-method" value="card" onchange="togglePaymentFields()" required> Card
          </label>
          <label>
            <input type="radio" name="payment-method" value="mpesa" onchange="togglePaymentFields()" required> Lipa na M-Pesa
          </label>
        </div>
      </div>

      <!-- Card Payment Fields -->
      <div id="card-payment" class="payment-details hidden">
        <div class="form-group">
          <label for="card-number">Card Number</label>
          <input type="text" id="card-number" name="card-number" placeholder="1234 5678 9012 3456">
        </div>
        <div class="form-row">
          <div class="form-group half-width">
            <label for="expiry">Expiry Date</label>
            <input type="text" id="expiry" name="expiry" placeholder="MM/YY">
          </div>
          <div class="form-group half-width">
            <label for="cvv">CVV</label>
            <input type="text" id="cvv" name="cvv" placeholder="123">
          </div>
        </div>
      </div>

      <!-- M-Pesa Payment Fields -->
      <div id="mpesa-payment" class="payment-details hidden">
        <div class="form-group">
          <label for="mpesa-phone">M-Pesa Phone Number</label>
          <input type="tel" id="mpesa-phone" name="mpesa-phone" placeholder="e.g., 0712345678">
          <p class="info-text">An STK push will be sent to this number to complete the payment.</p>
        </div>
      </div>

      <!-- Submit Button -->
      <button type="submit" class="submit-button">Register & Pay</button>
    </form>
  </div>

  <footer class="footer">
    <p class="text-wrapper">Â© 2025 Strathmore University Table Tennis Club. All rights reserved.</p>
  </footer>
</div>

<script>
  // Toggle payment fields based on payment method
  function togglePaymentFields() {
    const cardFields = document.getElementById('card-payment');
    const mpesaFields = document.getElementById('mpesa-payment');
    const paymentMethod = document.querySelector('input[name="payment-method"]:checked')?.value;

    cardFields.classList.add('hidden');
    mpesaFields.classList.add('hidden');

    if (paymentMethod === 'card') {
      cardFields.classList.remove('hidden');
    } else if (paymentMethod === 'mpesa') {
      mpesaFields.classList.remove('hidden');
    }
  }

  // Update form based on selected categories
  function updateForm() {
    const categories = document.querySelectorAll('input[name="category"]:checked');
    const mixedTeamDetails = document.getElementById('mixed-team-details');
    const familyTeamDetails = document.getElementById('family-team-details');
    const feeDisplay = document.getElementById('fee-display');

    // Toggle team details visibility
    const isMixedTeamSelected = Array.from(categories).some(cat => cat.value === 'mixed-team');
    const isFamilyTeamSelected = Array.from(categories).some(cat => cat.value === 'family-team');

    mixedTeamDetails.classList.toggle('hidden', !isMixedTeamSelected);
    familyTeamDetails.classList.toggle('hidden', !isFamilyTeamSelected);

    // Set required attribute for team name fields
    document.getElementById('mixed-team-name').required = isMixedTeamSelected;
    document.getElementById('family-team-name').required = isFamilyTeamSelected;
    const mixedTeamMembers = document.querySelectorAll('#mixed-team-details .team-member');
    mixedTeamMembers.forEach(member => member.required = isMixedTeamSelected);

    // Calculate total fee
    const fees = {
      'under-18': 1,
      'singles': 400,
      'mixed-team': 1800,
      'family-team': 1000
    };
    let totalFee = 0;
    categories.forEach(category => {
      totalFee += fees[category.value] || 0;
    });
    feeDisplay.textContent = totalFee > 0 ? `${totalFee} Kshs` : 'Select categories to see the total fee';

    return totalFee; // Return the total fee for use in handlePayment
  }

  // Handle form submission, save registration, and initiate payment
  async function handlePayment(event) {
    event.preventDefault();

    const categories = document.querySelectorAll('input[name="category"]:checked');
    const paymentMethod = document.querySelector('input[name="payment-method"]:checked')?.value;
    const totalFee = updateForm();

    // Validate categories
    if (categories.length === 0) {
      alert('Please select at least one tournament category.');
      return false;
    }

    // Validate team details if applicable
    const isMixedTeamSelected = Array.from(categories).some(cat => cat.value === 'mixed-team');
    const isFamilyTeamSelected = Array.from(categories).some(cat => cat.value === 'family-team');

    if (isMixedTeamSelected) {
      const mixedTeamName = document.getElementById('mixed-team-name').value;
      const mixedTeamMembers = Array.from(document.querySelectorAll('#mixed-team-details .team-member')).map(member => member.value);
      if (!mixedTeamName) {
        alert('Please enter your Mixed Team name.');
        return false;
      }
      for (let member of mixedTeamMembers) {
        if (!member) {
          alert('Please enter all Mixed Team member names.');
          return false;
        }
      }
    }

    if (isFamilyTeamSelected) {
      const familyTeamName = document.getElementById('family-team-name').value;
      if (!familyTeamName) {
        alert('Please enter your Family Team name.');
        return false;
      }
    }

    // Collect registration data
    const fullName = document.getElementById('full-name').value;
    const phone = document.getElementById('phone').value;
    const gender = document.querySelector('input[name="gender"]:checked')?.value;
    const selectedCategories = Array.from(categories).map(cat => cat.value);
    const mixedTeamName = isMixedTeamSelected ? document.getElementById('mixed-team-name').value : null;
    const mixedTeamMembers = isMixedTeamSelected
      ? Array.from(document.querySelectorAll('#mixed-team-details .team-member')).map(member => member.value)
      : null;
    const familyTeamName = isFamilyTeamSelected ? document.getElementById('family-team-name').value : null;

    const registrationData = {
      fullName,
      phone,
      gender,
      categories: selectedCategories,
      mixedTeamName,
      mixedTeamMembers,
      familyTeamName,
    };

    // Save registration data to PostgreSQL
    try {
      const saveResponse = await fetch('https://suttcwebapp-backend.onrender.com/saveRegistration', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(registrationData),
      });

      const saveResult = await saveResponse.json();
      if (saveResponse.status !== 200) {
        throw new Error(saveResult.error || 'Failed to save registration data');
      }
    } catch (error) {
      alert('Error saving registration data: ' + error.message);
      return false;
    }

    // Handle payment
    if (paymentMethod === 'mpesa') {
      const mpesaPhone = document.getElementById('mpesa-phone').value;
      if (!mpesaPhone || !mpesaPhone.match(/^07\d{8}$/)) {
        alert('Please enter a valid M-Pesa phone number (e.g., 0712345678).');
        return false;
      }

      try {
        const response = await fetch('https://suttcwebapp-backend.onrender.com/initiateStkPush', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            phoneNumber: mpesaPhone,
            amount: totalFee,
          }),
        });

        const result = await response.json();
        if (result.ResponseCode === '0') {
          alert('STK Push initiated. Please check your phone and enter your M-Pesa PIN to complete the payment.');
        } else {
          alert('Failed to initiate payment: ' + (result.ResponseDescription || 'Unknown error'));
        }
      } catch (error) {
        alert('Error initiating payment: ' + error.message);
        return false;
      }
    } else if (paymentMethod === 'card') {
      const cardNumber = document.getElementById('card-number').value;
      const expiry = document.getElementById('expiry').value;
      const cvv = document.getElementById('cvv').value;
      if (!cardNumber || !expiry || !cvv) {
        alert('Please fill in all card details.');
        return false;
      }
      alert('Card payment processing is not implemented in this example.');
    }

    return false; // Prevent form submission
  }

  // Navigation bar scroll effect
  window.addEventListener('scroll', function() {
    const nav = document.querySelector('.navigation');
    if (window.scrollY > 50) {
      nav.classList.add('visible');
    } else {
      nav.classList.remove('visible');
    }
  });

  // Hamburger menu toggle
  document.querySelector('.hamburger-menu').addEventListener('click', function() {
    const navButtons = document.querySelector('.nav-buttons');
    navButtons.classList.toggle('active');
    this.classList.toggle('open');
  });
</script>
</body>
</html>
